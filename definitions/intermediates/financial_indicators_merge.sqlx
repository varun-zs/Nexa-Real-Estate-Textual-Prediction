-- Configure the Dataform view
config {
  type: "view",
  schema: "uk_real_estate",
  name: "financial_data_merge"
}

-- Create a view with specified columns from each table
SELECT 
  FORMAT_DATE('%m/%Y', PARSE_DATE('%Y-%m', t1.date)) AS timeseries,
  t1.interest_rate AS interest_rate,
  t2.inflation_rate AS inflation_rate,
  t3.Party AS political_party,
  (t4.variable_rate + t4.fixed_rate) / 2 AS mortgage_rates,
  t5.value AS pandemic_severity_rate
FROM
  ${ref("interest_rates_table")} t1
LEFT JOIN ${ref("inflation_rates_table")} t2
ON FORMAT_DATE('%m/%Y', PARSE_DATE('%Y-%m', t1.date)) = FORMAT_DATE('%m/%Y', PARSE_DATE('%m/%d/%Y', t2.date))
LEFT JOIN ${ref("political_party_table")} t3
ON FORMAT_DATE('%m/%Y', PARSE_DATE('%Y-%m', t1.date)) = FORMAT_DATE('%m/%Y', PARSE_DATE('%Y-%m-%d', t3.date))
LEFT JOIN ${ref("mortgage_rates_table")} t4
ON FORMAT_DATE('%m/%Y', PARSE_DATE('%Y-%m', t1.date)) = FORMAT_DATE('%m/%Y', PARSE_DATE('%Y/%m', t4.date))
LEFT JOIN ${ref("pandemic_severity_table")} t5
ON FORMAT_DATE('%m/%Y', PARSE_DATE('%Y-%m', t1.date)) = FORMAT_DATE('%m/%Y', PARSE_DATE('%Y-%m-%d', t5.month))