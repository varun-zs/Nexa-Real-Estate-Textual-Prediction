-- Configure the Dataform view
config {
  type: "view",
  schema: "uk_real_estate",
  name: "income_merge"
}

SELECT
  FORMAT_DATE('%m/%Y', PARSE_DATE('%m/%d/%Y', t2.period)) AS timeseries,
  t1.area_code AS area_code,
  t1.area_name AS area_name,
  (t1.gross_disposable_income / 12) AS gross_disposable_income,
  t2.employment_rate AS employment_rate,
  t3.gross_median_income AS gross_median_income
FROM
  ${ref("gross_disposable_income_table")} t1
LEFT JOIN ${ref("employment_rates_table")} t2
ON t1.area_code = t2.area_code AND
  t1.area_name = t2.area_name AND
  FORMAT_DATE('%Y', ds.datemonth) = FORMAT_DATE('%Y', PARSE_DATE('%m/%d/%Y', t2.period))
LEFT JOIN ${ref("gross_median_income_table")} t3
ON t1.area_code = t3.area_code AND
  t1.area_name = t3.area_name AND
  FORMAT_DATE('%Y', ds.datemonth) = t3.period